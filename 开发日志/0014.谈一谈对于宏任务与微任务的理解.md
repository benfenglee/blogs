# 理解前端中的宏任务与微任务
在JavaScript中，宏任务和微任务是两种不同的任务队列，他们是在事件循环中以不同优先级的和时机来执行的。理解宏任务与微任务的区别以及他们如何影响代码的执行走向是日常开发中非常重要的关键。
## 1.事件循环
JavaScript是单线程的，这意味着它一次只能执行一个任务 ，为了处理异步操作，JavaScript引进了事件循环机制。事件循环的主要作用是不断的从任务队列中取出任务，并执行。  
**事件循环的基本流程如下：**
- 1.执行全局同步代码（主线程）。
- 2.检查微任务队列是否有任务。如果有执行所有的微任务。
- 3.执行一个宏任务。
- 4.重复执行步骤2和3，直到任务队列清空。
## 2.宏任务
宏任务常见是需要被执行比较大的任务，每个事件循环中都会有一个宏任务被执行。

### 常见的宏任务：
- `setTimeout`、`setInterval`。
- 用户交互事件（如点击、输入等）。
- I/O操作（读写文件、网络请求）。
- `requestAnimationFrame`。  

每执行一个宏任务完成后，事件循环都会去检查微任务队列 ，如果队列不为空则优先执行所有的微任务。

### 宏任务执行流程：
- 宏任务会首先被加入到宏任务队列。
- 在事件循环的每一轮中，宏任务会被逐个取出并执行。

## 2.微任务
微任务是比较小的任务，优先级高于宏任务。微任务通常用于处理一些 轻量级的异步操作，保证它们在当前事件循环的同步代码执行完成后立即执行。

### 常见的微任务：
- Promise的then、catch、finally。
- MutationObserver用于监听DOM变化，其回调函数作为微任务执行。
- queueMicrotask浏览器提供的API，显式的添加微任务。
- async/await中的 await 会被转换为Promise的.then回调，也属于微任务。

### 微任务执行流程：
- 微任务会在每次宏任务执行后、下一轮事件循环开始前执行。
- 在宏任务执行完成后，事件循环会优先执行所有待执行的微任务队列中的任务，知道队列清空。

## 4.宏任务与微任务的执行顺序
- 在每一轮事件循环中，先执行所有的同步代码。
- 然后执行所有的微任务。
- 最后执行一个宏任务。

### 示例
```js
console.log('开始');

setTimeout(() => {
  console.log('宏任务1');
}, 0);

Promise.resolve().then(() => {
  console.log('微任务1');
});

setTimeout(() => {
  console.log('宏任务2');
}, 0);

Promise.resolve().then(() => {
  console.log('微任务2');
});

console.log('结束');
```
### 执行顺序
**1.同步代码**：`开始`和`结束`会首先打印。  
**2.微任务**：`微任务1`和`微任务2`会接着打印。  
**3.宏任务**：`宏任务1`和`宏任务2`会最后打印。
```log
'开始'
'结束'
'微任务1'
'微任务2'
'宏任务1'
'宏任务2'
```
- 事件循环首先执行同步代码打印`开始`和`结束`。
- 然后进入微任务队列，先执行`微任务1`再执行`微任务2`。
- 微任务队列为空后，开始执行宏任务中的任务（逐个执行）。

## 5.事件循环图解
| 执行同步代码（主进程）  |
|----|
|执行所有微任务|
|执行一个宏任务|
|执行所有微任务|
|执行下一个宏任务|

## 6.注意点
- 微任务中产生新的微任务：如果微任务在执行中添加了新的微任务（比如在 `Promise.then` 内再调用一个 `Promise`），这些微任务会被添加到本次微任务执行队列中，而不是等到下一个宏任务执行。
```js
console.log('开始');

Promise.resolve().then(() => {
  console.log('微任务1');
  Promise.resolve().then(() => {
    console.log('微任务2');
  });
});
setTimeout(() => {
  console.log('宏任务1');
}, 0);

console.log('结束');
```
```log
开始
结束
微任务1
微任务2
宏任务1
```
在同一个微任务队列中，所有微任务会被执行完才会进入宏任务队列。


## 总结
- 宏任务：包括 `setTimeout`、`setInterval`、`I/O` 操作、`UI` 事件等，每次事件循环中从宏任务队列中取出并执行一个任务。
- 微任务：包括 `Promise.then`/`catch`/`finally`、`MutationObserver`、`queueMicrotask` 等，微任务在每次事件循环中会在执行完同步代码后、执行宏任务之前执行。