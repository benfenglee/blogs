# 你知道你的JavaScript代码是如何执行的吗
---
前端的 **事件循环(Event Loop)** 是非常重要的一个概念，理解事件循环对于JavaScript的异步事件执行非常关键。他涉及如何处理异步任务，如何调度执行栈中的代码。

## 1.JavaScript的执行方式
JavaScript在浏览器中是单线程执行的，这意味着它在任意时刻只能执行一段代码。尽管如此，JavaScript还是能够处理多个任务并且异步执行，这背后就是事件循环机制功劳。

JavaScript的代码执行主要是通过 **调用栈(Call Stack)** 和**消息队列(Message Queue)** 来管理。

## 2.执行栈(Call Stack)
- 栈就是一个 **LIFO(后进先出)** 的结构，用来存储当前执行的函数。
- 当调用一个函数时，它会被推入栈中，执行完成后再从栈中弹出。
-  **同步代码** 会直接进入栈并按顺序执行

## 3.消息队列(Message Queue)
- **消息队列**(有时候也叫任务队列)，用来存放待执行任务的地方，事件循环的任务是从消息队列中将任务取出并执行。
- 异步任务(定时器、I/O操作等等)会放入消息队列中进行等待执行。

## 4.事件循环(Event Loop)
- **事件循环**是负责检查执行栈和消息队列的机制，它负责哪些任务可以从消息队列中取出来并执行。
- 事件循环的主要工作就是不断地检测执行栈是否为空，如果为空，他就会将消息队列中的第一个任务（回调函数）移入执行栈并执行

## 5.异步任务的执行顺序
JavaScript中的异步任务有两种常见的类型：
- **宏任务(Macor Tasks)**
	- 包含：`setTimeout`、`setInterval`、`I/O操作`、`UI渲染`、`事件回调`等等。
- **微任务(Micor Tasks)**
	- 包含：`Promise`的`.then()`、`.catch()`、`finally()`、`MutationObserver`等等。

执行流程：

	1.同步代码（栈里的代码首先被执行）。
	2.其次微任务（比如通过Promise注册的回调），在当前执行栈清空后立即执行所有的微任务。
	3.宏任务 会在微任务清空后执行，每次从消息队列中取出一个宏任务进行执行。
	4.当执行完当前宏任务后，浏览器会渲染页面，之后事件循环继续。

## 6.执行顺序示例
```js
console.log('同步任务 1') // 同步任务

setTimeout(()=>{
	console.log('宏任务 1')
},0)

Promise.resolve().then(()=>{
	console.log('微任务 1')
})

console.log('同步任务 2')
```
### 执行顺序:
1.同步任务`console.log(同步任务 1)`执行  
2.`setTimeout()`作为宏任务放入消息队列，等待执行  
3.`Promise.resolve()`作为微任务放入消息队列  
4.同步任务 `console.log(同步任务 2)` 执行  
5.当前执行栈被清空，事件循环执行微任务队列，取出`console.log(微任务 1)`执行  
6.微任务队列清空后，事件循环执行宏任务队列，取出`console.log(宏任务 1)`执行

### 所以最后的结果是:
	>同步任务 1
	>同步任务 2
	>微任务 1
	>宏任务 1

## 7.宏任务与微任务的区别
- 宏任务：每次从消息队列中取出一个任务来执行，宏任务的执行顺序是严格按照入队顺序来执行的，常见的宏任务包括：
	- `setTimeout`、`setInterval`、`I/O操作`、`UI渲染`、`事件回调`。
- 微任务：微任务优先于宏任务执行，在当前宏任务执行完成之后下一个宏任务执行之前完成。微任务通常用于执行轻量级的任务，比如Promise的回调，常见的微任务包括：
	- `Promise.then.catch.finally`、`MutationObserver`。

## 8.浏览器与事件循环
在事件循环的每一轮，JavaScript执行完同步代码、微任务以及宏任务后，浏览器会进行页面的渲染工作。渲染工作包含：
- 重绘（Repaint）：更新视觉上的样式（比如背景色、字体颜色等）。
- 回流（Reflow）：布局计算，例如元素的大小和位置。
>重绘的代价通常都要比回流小，因为回流会涉及到页面的完整布局运算，所以尽量避免出发回流，导致性能瓶颈。

## 9.事件循环的实际影响
- 性能优化：事件循环机制有助于保证页面交互的流畅性。通过合理的安排同步以及异步代码的执行顺序，可以避免页面卡顿或者响应延迟。
- UI线程与JavaScript线程：浏览器通常会有多个线程，UI渲染和JavaScript的事件循环通常在不同的线程执行。UI渲染线程会等待JavaScript执行完所有的同步代码和微任务后再进行渲染操作。

## 10.总结
- 事件循环可以使JavaScript能够处理异步任务并在单线程的环境中执行多个操作。
- 微任务（如Promise的回调）优先于宏任务执行（如setTimeout）。
- 理解事件循环可以避免提早遇到性能瓶颈、使交互操作更流畅。